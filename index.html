<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bono Contribución Bomberos 2025</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body {font-family: Arial, sans-serif; margin:20px; background:#f0f8ff; color:#333;}
    h1 {text-align:center; color:#2c3e50; font-size: 2.5em; margin-bottom: 10px;}
    .subtitle {text-align:center; color:#e74c3c; font-size: 1.4em; margin-top: -10px;}
    
    .controls {
      text-align:center; margin:30px 0; display:flex; justify-content:center; gap:8px;
      flex-wrap: wrap; padding:10px;
    }
    .filter-btn {
      padding:10px 16px; background:#3498db; color:white;
      border:none; border-radius:10px; cursor:pointer; font-size:15px; 
      font-weight:bold; white-space:nowrap;
    }
    .filter-btn.active {background:#e74c3c; transform:scale(1.08);}
    .cantidad {font-size:12px; opacity:0.9;}

    .search {text-align:center; margin:30px;}
    input {
      padding:16px; width:90%; max-width:800px; font-size:19px; 
      border:3px solid #3498db; border-radius:16px; background:#fff;
    }

    table {
      width:100%; border-collapse:separate; border-spacing:0;
      background:white; box-shadow:0 8px 30px rgba(0,0,0,0.2); 
      border-radius:16px; overflow:hidden; margin-top:20px;
      border: 2px solid #3498db;
    }
    th {
      background:#3498db; color:white; padding:16px; position:sticky; top:0;
      border-bottom: 3px solid #2980b9;
      font-weight: bold; text-align: center;
    }
    td {
      padding:14px; text-align:center; vertical-align:middle;
      border-bottom:1px solid #ddd; border-right:1px solid #ddd;
    }
    td:first-child {border-left:none;}
    th:first-child, td:first-child {text-align:left; font-weight:bold;}

    /* Bordes redondeados solo en las esquinas */
    th:first-child {border-top-left-radius:14px;}
    th:last-child {border-top-right-radius:14px;}
    tbody tr:last-child td:first-child {border-bottom-left-radius:14px;}
    tbody tr:last-child td:last-child {border-bottom-right-radius:14px;}

    /* Colores alternados + hover */
    tbody tr:nth-child(odd) {background-color:#f8fdff;}
    tbody tr:nth-child(even) {background-color:#e3f2fd;}
    tbody tr:hover {background-color:#bbdefb !important;}

    /* Números colapsables */
    .talon-principal {
      background:#1565c0; color:white; padding:10px 18px; border-radius:12px; 
      font-weight:bold; font-size:18px; cursor:pointer; display:inline-block;
      box-shadow: 0 3px 10px rgba(0,0,0,0.3);
    }
    .talon-principal:hover {background:#0d47a1; transform:translateY(-1px);}
    .talones-extra {
      margin-top:10px; display:none; flex-wrap:wrap; gap:8px; justify-content:center;
    }
    .talones-extra.mostrar {display:flex !important;}
    .talon-extra {
      background:#1976d2; color:white; padding:8px 14px; border-radius:10px; 
      font-weight:bold; font-size:16px;
    }

    .footer {text-align:center; margin:60px 20px; font-size:1.4em; color:#555; font-weight:bold;}
  </style>
</head>
<body>
  <h1>Bono Contribución Bomberos 2025</h1>
  <div class="subtitle">Concepción del Uruguay</div>

  <div class="controls">
    <button class="filter-btn active" data-pata="todas">TODAS <span class="cantidad" id="cant-todas">(0)</span></button>
    <button class="filter-btn" data-pata="1">PATA 1 <span class="cantidad" id="cant-1">(0)</span></button>
    <button class="filter-btn" data-pata="2">PATA 2 <span class="cantidad" id="cant-2">(0)</span></button>
    <button class="filter-btn" data-pata="3">PATA 3 <span class="cantidad" id="cant-3">(0)</span></button>
    <button class="filter-btn" data-pata="4">PATA 4 <span class="cantidad" id="cant-4">(0)</span></button>
    <button class="filter-btn" data-pata="5">PATA 5 <span class="cantidad" id="cant-5">(0)</span></button>
    <button class="filter-btn" data-pata="6">PATA 6 <span class="cantidad" id="cant-6">(0)</span></button>
  </div>
 
  <div class="search">
    <input type="text" id="buscar" placeholder="Buscar: número (ej: 83), apellido, dirección, zona, cobrador...">
  </div>
 
  <table id="tabla">
    <thead>
      <tr>
        <th>Pata</th>
        <th>Números</th>
        <th>Apellido y Nombre</th>
        <th>Dirección</th>
        <th>Zona</th>
        <th>Teléfono</th>
        <th>Fecha</th>
        <th>Cobrador</th>
        <th>Condición</th>
        <th>Vendedor</th>
        <th>Cuotas</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
 
  <div class="footer">
    Total: <strong id="total">0</strong> bonos | Mostrando: <strong id="vistos">0</strong>
  </div>

  <script>
    const patas = [
      {num: 1, url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQCWq1IBr07-uCsKpr1Npkr4S4rLfPPgLwXLhIBF7drigXY2sG9P-fKYpHojpedIuS5UeVBO2pV4oxj/pub?gid=1876560847&single=true&output=csv", talones: 3},
      {num: 2, url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQCWq1IBr07-uCsKpr1Npkr4S4rLfPPgLwXLhIBF7drigXY2sG9P-fKYpHojpedIuS5UeVBO2pV4oxj/pub?gid=1690951467&single=true&output=csv", talones: 6},
      {num: 3, url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQCWq1IBr07-uCsKpr1Npkr4S4rLfPPgLwXLhIBF7drigXY2sG9P-fKYpHojpedIuS5UeVBO2pV4oxj/pub?gid=1380861405&single=true&output=csv", talones: 9},
      {num: 4, url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQCWq1IBr07-uCsKpr1Npkr4S4rLfPPgLwXLhIBF7drigXY2sG9P-fKYpHojpedIuS5UeVBO2pV4oxj/pub?gid=1390334418&single=true&output=csv", talones: 12},
      {num: 5, url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQCWq1IBr07-uCsKpr1Npkr4S4rLfPPgLwXLhIBF7drigXY2sG9P-fKYpHojpedIuS5UeVBO2pV4oxj/pub?gid=1559471229&single=true&output=csv", talones: 15},
      {num: 6, url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQCWq1IBr07-uCsKpr1Npkr4S4rLfPPgLwXLhIBF7drigXY2sG9P-fKYpHojpedIuS5UeVBO2pV4oxj/pub?gid=1875702601&single=true&output=csv", talones: 18}
    ];

    const tbody = document.querySelector("#tabla tbody");
    const inputBuscar = document.getElementById("buscar");
    let filas = [];
    let filtroPata = "todas";
    const cantidades = {todas: 0, 1:0, 2:0, 3:0, 4:0, 5:0, 6:0};

    function ordenarPorPataYNumero() {
      filas.sort((a, b) => {
        const diff = parseInt(a.dataset.pata) - parseInt(b.dataset.pata);
        return diff !== 0 ? diff : a.dataset.primerTalon.localeCompare(b.dataset.primerTalon);
      });
      filas.forEach(tr => tbody.appendChild(tr));
    }

    patas.forEach(pata => {
      Papa.parse(pata.url, {
        download: true,
        skipEmptyLines: true,
        complete: function(results) {
          results.data.forEach(fila => {
            if (!fila[0] || fila[0] === "Talones" || !/^\d{4}$/.test(fila[0].trim())) return;
            const talonesArray = fila.slice(0, pata.talones).map(t => t.trim()).filter(t => /^\d{4}$/.test(t));
            if (talonesArray.length === 0) return;

            const primerTalon = talonesArray[0];
            let col = pata.talones;
            while (col < fila.length && (!fila[col] || fila[col].trim() === "")) col++;
            const nombre = (fila[col] || "").trim() || "-";
            const direccion = (fila[col+1] || "").trim() || "-";
            const zona = (fila[col+2] || "").trim() || "-";
            const telefono = (fila[col+3] || "").trim() || "-";
            const fecha = (fila[col+4] || "").trim() || "-";
            const cobrador = (fila[col+5] || "").trim() || "-";
            const condicion = (fila[col+6] || "").trim() || "-";
            const vendedor = (fila[col+7] || "").trim() || "-";
            const cuotas = (fila[col+8] || "").trim() || "-";

            const tr = document.createElement("tr");
            tr.dataset.pata = pata.num;
            tr.dataset.primerTalon = primerTalon;
            tr.dataset.numeros = JSON.stringify(talonesArray);

            const extraHtml = talonesArray.slice(1).map(t => `<span class="talon-extra">${t}</span>`).join("");
            const totalExtra = talonesArray.length - 1;
            const textoExtra = totalExtra > 0 ? ` +${totalExtra}` : "";

            tr.innerHTML = `
              <td><strong>Pata ${pata.num}</strong></td>
              <td>
                <div style="line-height:2.4">
                  <span class="talon-principal" onclick="this.parentElement.querySelector('.talones-extra').classList.toggle('mostrar')">
                    ${primerTalon}<span style="font-size:14px;opacity:0.9;">${textoExtra}</span>
                  </span>
                  <div class="talones-extra">${extraHtml}</div>
                </div>
              </td>
              <td>${nombre}</td>
              <td>${direccion}</td>
              <td>${zona}</td>
              <td>${telefono}</td>
              <td>${fecha}</td>
              <td>${cobrador}</td>
              <td>${condicion}</td>
              <td>${vendedor}</td>
              <td>${cuotas}</td>
            `;
            tbody.appendChild(tr);
            filas.push(tr);
            cantidades[pata.num]++;
            cantidades.todas++;
          });

          if (filas.length === cantidades.todas) {
            document.getElementById("total").textContent = cantidades.todas;
            document.getElementById("cant-todas").textContent = ` (${cantidades.todas})`;
            for (let i = 1; i <= 6; i++) document.getElementById(`cant-${i}`).textContent = ` (${cantidades[i]})`;
            ordenarPorPataYNumero();
            aplicarFiltros();
          }
        }
      });
    });

    function aplicarFiltros() {
      const texto = inputBuscar.value.trim();
      const textoLower = texto.toLowerCase().replace(/\s+/g, " ");
      let visibles = 0;
      let indiceVisible = 0;

      filas.forEach(tr => {
        const pataOk = (filtroPata === "todas" || tr.dataset.pata === filtroPata);
        if (!pataOk) { tr.style.display = "none"; return; }

        let coincide = false;
        const numerosFila = JSON.parse(tr.dataset.numeros);

        if (!texto) coincide = true;
        else if (/^\d{1,4}$/.test(texto)) {
          const busqueda = texto;
          if (busqueda.length >= 3) {
            const padded = busqueda.padStart(4, "0");
            coincide = numerosFila.some(t => t.slice(-3) === padded.slice(-3) || t === padded);
          } else {
            const terminacion = busqueda.padStart(2, "0").slice(-2);
            coincide = numerosFila.some(t => t.endsWith(terminacion));
          }
        } else {
          coincide = tr.textContent.toLowerCase().replace(/\s+/g, " ").includes(textoLower);
        }

        if (coincide) {
          tr.style.display = "";
          tr.style.backgroundColor = indiceVisible % 2 === 0 ? "#e3f2fd" : "#f8fdff";
          visibles++;
          indiceVisible++;

          if (texto) {
            tr.querySelector('.talones-extra').classList.add('mostrar');
          } else {
            tr.querySelector('.talones-extra').classList.remove('mostrar');
          }
        } else {
          tr.style.display = "none";
        }
      });

      document.getElementById("vistos").textContent = visibles;
    }

    inputBuscar.addEventListener("input", aplicarFiltros);

    document.querySelectorAll(".filter-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".filter-btn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        filtroPata = btn.dataset.pata;
        inputBuscar.value = "";
        aplicarFiltros();
      });
    });
  </script>
</body>
</html>
