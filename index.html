<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bono Contribución Bomberos 2025</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body {font-family: Arial, sans-serif; margin:20px; background:#f0f8ff; color:#333;}
    h1 {text-align:center; color:#2c3e50; font-size: 2.5em; margin-bottom: 10px;}
    .subtitle {text-align:center; color:#e74c3c; font-size: 1.4em; margin-top: -10px;}
    
    /* Botones pata más chicos y bonitos */
    .controls {
      text-align:center; margin:30px 0; display:flex; justify-content:center; gap:8px;
      flex-wrap: wrap; padding:10px;
    }
    .filter-btn {
      padding:10px 16px; background:#3498db; color:white;
      border:none; border-radius:10px; cursor:pointer; font-size:15px; 
      font-weight:bold; white-space:nowrap;
    }
    .filter-btn.active {background:#e74c3c; transform:scale(1.08);}
    .cantidad {font-size:12px; opacity:0.9;}

    .search {text-align:center; margin:30px;}
    input {
      padding:16px; width:90%; max-width:800px; font-size:19px; 
      border:3px solid #3498db; border-radius:16px;
      background:#fff;
    }
    table {width:100%; border-collapse:collapse; background:white; 
           box-shadow:0 6px 25px rgba(0,0,0,0.15); border-radius:14px; overflow:hidden; margin-top:20px;}
    th {background:#3498db; color:white; padding:16px; position:sticky; top:0; cursor:pointer;}
    th:hover {background:#2980b9;}
    th.sort-asc::after {content:" Up Arrow"; margin-left:8px;}
    th.sort-desc::after {content:" Down Arrow"; margin-left:8px;}
    td {padding:14px; border-bottom:1px solid #ddd; vertical-align: top;}
    
    /* MANTIENE EL COLOR DE FILAS AL FILTRAR */
    tbody tr {background-color: #ffffff;}
    tbody tr:nth-child(odd) {background-color: #e3f2fd;}
    tbody tr:hover {background-color: #bbdefb !important;}

    .talones-container {display: flex; flex-wrap: nowrap; gap: 10px; overflow-x: auto; padding: 8px 0;}
    .talon-badge {background:#1565c0; color:white; padding:8px 16px; border-radius:10px; font-weight:bold; font-size:17px; white-space:nowrap;}
    .footer {text-align:center; margin:50px; font-size:1.3em; color:#555;}
  </style>
</head>
<body>
  <h1>Bono Contribución Bomberos 2025</h1>
  <div class="subtitle">Concepción del Uruguay</div>

  <div class="controls">
    <button class="filter-btn active" data-pata="todas">TODAS <span class="cantidad" id="cant-todas">(0)</span></button>
    <button class="filter-btn" data-pata="1">PATA 1 <span class="cantidad" id="cant-1">(0)</span></button>
    <button class="filter-btn" data-pata="2">PATA 2 <span class="cantidad" id="cant-2">(0)</span></button>
    <button class="filter-btn" data-pata="3">PATA 3 <span class="cantidad" id="cant-3">(0)</span></button>
    <button class="filter-btn" data-pata="4">PATA 4 <span class="cantidad" id="cant-4">(0)</span></button>
    <button class="filter-btn" data-pata="5">PATA 5 <span class="cantidad" id="cant-5">(0)</span></button>
    <button class="filter-btn" data-pata="6">PATA 6 <span class="cantidad" id="cant-6">(0)</span></button>
  </div>
 
  <div class="search">
    <input type="text" id="buscar" placeholder="Escriba aquí: número (ej: 83), apellido, nombre, dirección, zona, cobrador...">
  </div>
 
  <table id="tabla">
    <thead>
      <tr>
        <th>Pata</th>
        <th class="sortable" data-col="talon">Números</th>
        <th class="sortable" data-col="nombre">Apellido y Nombre</th>
        <th class="sortable" data-col="direccion">Dirección</th>
        <th class="sortable" data-col="zona">Zona</th>
        <th class="sortable" data-col="telefono">Teléfono</th>
        <th class="sortable" data-col="fecha">Fecha</th>
        <th class="sortable" data-col="cobrador">Cobrador</th>
        <th class="sortable" data-col="condicion">Condición</th>
        <th class="sortable" data-col="vendedor">Vendedor</th>
        <th class="sortable" data-col="cuotas">Cuotas</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
 
  <div class="footer">
    Total: <strong id="total">0</strong> bonos | Mostrando: <strong id="vistos">0</strong>
  </div>

  <script>
    const patas = [
      {num: 1, url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQCWq1IBr07-uCsKpr1Npkr4S4rLfPPgLwXLhIBF7drigXY2sG9P-fKYpHojpedIuS5UeVBO2pV4oxj/pub?gid=1876560847&single=true&output=csv", talones: 3},
      {num: 2, url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQCWq1IBr07-uCsKpr1Npkr4S4rLfPPgLwXLhIBF7drigXY2sG9P-fKYpHojpedIuS5UeVBO2pV4oxj/pub?gid=1690951467&single=true&output=csv", talones: 6},
      {num: 3, url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQCWq1IBr07-uCsKpr1Npkr4S4rLfPPgLwXLhIBF7drigXY2sG9P-fKYpHojpedIuS5UeVBO2pV4oxj/pub?gid=1380861405&single=true&output=csv", talones: 9},
      {num: 4, url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQCWq1IBr07-uCsKpr1Npkr4S4rLfPPgLwXLhIBF7drigXY2sG9P-fKYpHojpedIuS5UeVBO2pV4oxj/pub?gid=1390334418&single=true&output=csv", talones: 12},
      {num: 5, url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQCWq1IBr07-uCsKpr1Npkr4S4rLfPPgLwXLhIBF7drigXY2sG9P-fKYpHojpedIuS5UeVBO2pV4oxj/pub?gid=1559471229&single=true&output=csv", talones: 15},
      {num: 6, url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQCWq1IBr07-uCsKpr1Npkr4S4rLfPPgLwXLhIBF7drigXY2sG9P-fKYpHojpedIuS5UeVBO2pV4oxj/pub?gid=1875702601&single=true&output=csv", talones: 18}
    ];

    const tbody = document.querySelector("#tabla tbody");
    const inputBuscar = document.getElementById("buscar");
    let filas = [];
    let filtroPata = "todas";
    const cantidades = {todas: 0, 1:0, 2:0, 3:0, 4:0, 5:0, 6:0};

    // Orden por pata + número al cargar
    function ordenarPorPataYNumero() {
      filas.sort((a, b) => {
        const diffPata = parseInt(a.dataset.pata) - parseInt(b.dataset.pata);
        if (diffPata !== 0) return diffPata;
        return a.dataset.primerTalon.localeCompare(b.dataset.primerTalon);
      });
      filas.forEach((tr, index) => {
        tbody.appendChild(tr);
        // Forzamos el color de fondo correcto (impar/par)
        tr.style.backgroundColor = index % 2 === 0 ? "#e3f2fd" : "#ffffff";
      });
    }

    // Carga de datos
    patas.forEach(pata => {
      Papa.parse(pata.url, {
        download: true,
        skipEmptyLines: true,
        complete: function(results) {
          results.data.forEach(fila => {
            if (!fila[0] || fila[0] === "Talones" || !/^\d{4}$/.test(fila[0].trim())) return;
            const talonesArray = fila.slice(0, pata.talones).map(t => t.trim()).filter(t => /^\d{4}$/.test(t));
            if (talonesArray.length === 0) return;

            const primerTalon = talonesArray[0];
            const talonesHtml = talonesArray.map(t => `<span class="talon-badge">${t}</span>`).join("");
            let col = pata.talones;
            while (col < fila.length && (!fila[col] || fila[col].trim() === "")) col++;
            const nombre = (fila[col] || "").trim() || "-";
            const direccion = (fila[col+1] || "").trim() || "-";
            const zona = (fila[col+2] || "").trim() || "-";
            const telefono = (fila[col+3] || "").trim() || "-";
            const fecha = (fila[col+4] || "").trim() || "-";
            const cobrador = (fila[col+5] || "").trim() || "-";
            const condicion = (fila[col+6] || "").trim() || "-";
            const vendedor = (fila[col+7] || "").trim() || "-";
            const cuotas = (fila[col+8] || "").trim() || "-";

            const tr = document.createElement("tr");
            tr.dataset.pata = pata.num;
            tr.dataset.primerTalon = primerTalon;
            tr.dataset.numeros = JSON.stringify(talonesArray);
            tr.innerHTML = `
              <td><strong>Pata ${pata.num}</strong></td>
              <td><div class="talones-container">${talonesHtml}</div></td>
              <td>${nombre}</td>
              <td>${direccion}</td>
              <td>${zona}</td>
              <td>${telefono}</td>
              <td>${fecha}</td>
              <td>${cobrador}</td>
              <td>${condicion}</td>
              <td>${vendedor}</td>
              <td>${cuotas}</td>
            `;
            tbody.appendChild(tr);
            filas.push(tr);
            cantidades[pata.num]++;
            cantidades.todas++;
          });

          // Cuando carguen todas → ordenar y mostrar
          if (filas.length === cantidades.todas) {
            document.getElementById("total").textContent = cantidades.todas;
            document.getElementById("cant-todas").textContent = ` (${cantidades.todas})`;
            for (let i = 1; i <= 6; i++) document.getElementById(`cant-${i}`).textContent = ` (${cantidades[i]})`;
            ordenarPorPataYNumero();
            aplicarFiltros();
          }
        }
      });
    });

    // BUSCADOR + MANTIENE COLORES
    function aplicarFiltros() {
      const texto = inputBuscar.value.trim();
      const textoLower = texto.toLowerCase().replace(/\s+/g, " ");
      let visibles = 0;
      let indiceVisible = 0;

      filas.forEach(tr => {
        const pataOk = (filtroPata === "todas" || tr.dataset.pata === filtroPata);
        if (!pataOk) {
          tr.style.display = "none";
          return;
        }

        let coincide = false;

        if (!texto) {
          coincide = true;
        } else if (/^\d{1,4}$/.test(texto)) {
          const busqueda = texto;
          const numerosFila = JSON.parse(tr.dataset.numeros);
          if (busqueda.length >= 3) {
            const padded = busqueda.padStart(4, "0");
            coincide = numerosFila.some(t => t.slice(-3) === padded.slice(-3) || t === padded);
          } else {
            const terminacion = busqueda.padStart(2, "0").slice(-2);
            coincide = numerosFila.some(t => t.endsWith(terminacion));
          }
        } else {
          coincide = tr.textContent.toLowerCase().replace(/\s+/g, " ").includes(textoLower);
        }

        if (coincide) {
          tr.style.display = "";
          // MANTIENE EL COLOR CELESTE/BLANCO SEGÚN POSICIÓN VISUAL
          tr.style.backgroundColor = indiceVisible % 2 === 0 ? "#e3f2fd" : "#ffffff";
          visibles++;
          indiceVisible++;
        } else {
          tr.style.display = "none";
        }
      });

      document.getElementById("vistos").textContent = visibles;
    }

    inputBuscar.addEventListener("input", aplicarFiltros);

    // Botones pata
    document.querySelectorAll(".filter-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".filter-btn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        filtroPata = btn.dataset.pata;
        inputBuscar.value = "";
        aplicarFiltros();
      });
    });
  </script>
</body>
</html>
